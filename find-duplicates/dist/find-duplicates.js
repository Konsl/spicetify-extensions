(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var n,l,o,a,t,e;function c(){if(!n.loadedIsrcCache){var e;try{n.isrcCache=JSON.parse(null!=(e=localStorage.getItem("find-duplicates:isrc-cache"))?e:"[]")}catch(e){n.isrcCache=[],console.error("find-duplicates: Error parsing ISRC cache: ",e)}n.loadedIsrcCache=!0}return n.isrcCache}function s(e){n.loadedIsrcCache=!0,n.isrcCache=e}function u(){if(!n.loadedLibraryIsrcCache){var e;try{n.libraryIsrcCache=JSON.parse(null!=(e=localStorage.getItem("find-duplicates:library-isrc-cache"))?e:"[]")}catch(e){n.libraryIsrcCache=[],console.error("find-duplicates: Error parsing library ISRC cache: ",e)}n.loadedLibraryIsrcCache=!0}return n.libraryIsrcCache}function d(e){n.loadedLibraryIsrcCache=!0,n.libraryIsrcCache=e}function f(){l.loaded=!0;let t=(null!=(e=window.webpackChunkclient_web)?e:window.webpackChunkopen).push([[Symbol()],{},e=>e]);var e=Object.keys(t.m).map(e=>t(e)).filter(e=>"object"==typeof e).map(e=>{try{return Object.values(e)}catch(e){}}).flat(),i=e.filter(e=>!(null==e||!e.type)&&e.$$typeof===Symbol.for("react.memo")&&"function"==typeof e.type&&(e=e.type.toString()).includes("defaultCurationContextUri")&&e.includes("web-player.aligned-curation")&&e.includes("isCurated")&&e.includes("default-curation")),i=[...new Set(i)];1!=i.length&&1!=(i=e.filter(e=>!(null==e||!e.type)&&"function"==typeof e.type&&(e=e.type.toString()).includes("remove-from-library")&&e.includes("add-to-library")&&e.includes("className")&&!e.includes("isEpisode"))).length||(l.heartRendererEntry=i[0],l.heartRenderer=l.heartRendererEntry.type)}async function p(){var e,i=await g([...new Set(o.registeredEntries.map(e=>e.uri))]);for(let t of o.registeredEntries)t.setState(y(t.uri,null==(e=i.find(e=>e[0]==t.uri))?void 0:e[1])),t.setup=!0;o.started=!1}function y(t,i){var e,r=u().filter(e=>e[1]==i),n=r.some(e=>e[0]==t);let a="";return n?(e=(r.findIndex(e=>e[0]==t)+1)%r.length,a=r[e][0]):0<r.length&&(a=r[0][0]),{count:r.length,saved:n,nextEntry:a}}function h(){l.loaded||f();var e=l.heartRendererEntry;e?(e.type=function(e){let i=e.uri,[r,n]=Spicetify.React.useState({count:0,saved:!1,nextEntry:""});Spicetify.React.useEffect(()=>{let t={uri:i,setState:n,setup:!1};var e;return e=t,o.registeredEntries.push(e),o.started||(o.started=!0,setTimeout(async()=>{var e;if(!S()){var i=o.registeredEntries.filter(e=>!e.setup),r=await g([...new Set(i.map(e=>e.uri))]);for(let t of i)t.setState(y(t.uri,null==(e=r.find(e=>e[0]==t.uri))?void 0:e[1])),t.setup=!0;o.started=!1}},0)),()=>{var e;e=t,0<=(e=o.registeredEntries.indexOf(e))&&o.registeredEntries.splice(e,1)}},[i]);var e=Spicetify.React.useCallback(()=>{var e,t="/collection/tracks?uri="+encodeURIComponent(r.nextEntry);return"/collection/tracks"===(null==(e=Spicetify.Platform.History.location)?void 0:e.pathname)?Spicetify.Platform.History.replace(t):Spicetify.Platform.History.push(t),!1},[r.nextEntry]),t=(l.loaded||f(),l.heartRenderer.apply(this,arguments)),a=r.count-(r.saved?1:0),c=r.saved?"+"+a:a.toString();return Spicetify.React.createElement(Spicetify.React.Fragment,{children:[a?Spicetify.React.createElement("a",{class:"TypeElement-mesto-textSubdued-type",href:"#",onClick:e},c):void 0,t]})},Spicetify.Platform.History.replace(Spicetify.Platform.History.location)):Spicetify.showNotification("Error while attaching save count",!0)}function m(){a.updateRunning?a.reUpdate=!0:async function e(){a.updateRunning=!0;let t=(await Spicetify.Platform.LibraryAPI.getTracks({limit:-1})).items.map(e=>e.uri);let i=u();let r=t.filter(t=>!i.find(e=>e[0]==t));let n=i.filter(e=>!t.includes(e[0])).map(e=>e[0]);i=i.filter(e=>!n.includes(e[0]));for(let e=0;e<r.length;e+=50){let t=r.slice(e,Math.min(e+50,r.length)).map(e=>null==(e=Spicetify.URI.from(e))?void 0:e.id).filter(e=>!!e);if(t.length){let e=(await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks?ids="+encodeURIComponent(t.join(",")))).tracks;i.push(...e.filter(e=>null==(e=null==e?void 0:e.external_ids)?void 0:e.isrc).map(e=>[e.uri,e.external_ids.isrc]))}}d(i);(a.reUpdate?(a.reUpdate=!1,e):p)();a.updateRunning=!1}()}function S(){return a.updateRunning}async function g(t){var i=c(),e=u();let r=i.filter(e=>t.includes(e[0]));r.push(...e.filter(e=>t.includes(e[0])));var n=t.filter(t=>!r.find(e=>e[0]==t));for(let e=0;e<n.length;e+=50){var a=n.slice(e,Math.min(e+50,n.length)).map(e=>null==(e=Spicetify.URI.from(e))?void 0:e.id).filter(e=>!!e);a.length&&(a=(await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks?ids="+encodeURIComponent(a.join(",")))).tracks.filter(e=>null==(e=null==e?void 0:e.external_ids)?void 0:e.isrc).map(e=>[e.uri,e.external_ids.isrc]),r.push(...a),i.push(...a))}return 2e3<i.length&&i.splice(0,i.length-2e3),s(i),r}function v(){var e;return null!=(e=t[Spicetify.Locale._locale])?e:t.en}(n=class{}).loadedIsrcCache=!1,(l=class{}).loaded=n.loadedLibraryIsrcCache=!1,(o=class{}).registeredEntries=[],(a=class{}).updateRunning=o.started=!1,a.reUpdate=!1,t={de:{contextMenuText:"Duplikate anzeigen",errorCouldNotRetrieveISRC:"Fehler: ISRC konnte nicht abgerufen werden"},en:{contextMenuText:"View Duplicates",errorCouldNotRetrieveISRC:"Error: Could not retrieve ISRC"}},e=async function(){for(var e;!(null!=Spicetify&&Spicetify.ContextMenu&&null!=Spicetify&&Spicetify.CosmosAsync&&null!=(e=null==Spicetify?void 0:Spicetify.Platform)&&e.History&&null!=Spicetify&&Spicetify.Locale&&null!=Spicetify&&Spicetify.URI&&(window.webpackChunkclient_web||window.webpackChunkopen));)await new Promise(e=>setTimeout(e,100));let{ContextMenu:t,Platform:i,URI:r}=Spicetify;Spicetify.Platform.LibraryAPI.getEvents().addListener("update",m),m(),h(),window.addEventListener("beforeunload",()=>{localStorage.setItem("find-duplicates:isrc-cache",JSON.stringify(n.isrcCache)),localStorage.setItem("find-duplicates:library-isrc-cache",JSON.stringify(n.libraryIsrcCache))}),new t.Item(v().contextMenuText,async e=>{e=await(async t=>{var e=c();if(i=e.find(e=>e[0]==t))return i[1];if(i=u().find(e=>e[0]==t))return i[1];if(!S()){var i=Spicetify.URI.from(t),i=null==i?void 0:i.id;if(i){i=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks/"+encodeURIComponent(i)),i=null==(i=null==i?void 0:i.external_ids)?void 0:i.isrc;if(i)return e.push([t,i]),2e3<e.length&&e.splice(0,e.length-2e3),s(e),i}}})(e[0]);e?i.History.push(`/search/${encodeURIComponent("isrc:"+e)}/tracks`):Spicetify.showNotification(v().errorCouldNotRetrieveISRC,!0)},e=>1==e.length&&(null==(e=r.from(e[0]))?void 0:e.type)==r.Type.TRACK).register()},(async()=>{await e()})()})();