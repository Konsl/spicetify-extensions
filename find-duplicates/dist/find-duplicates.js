(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var r,i,e,a,c,o,n,f,t,s,l,u;function d(){return a.metadataService||(a.metadataService=new e),a.metadataService}function h(){if(!a.loadedIsrcCache){try{a.isrcCache=JSON.parse(localStorage.getItem("find-duplicates:isrc-cache")??"[]")}catch(e){a.isrcCache=[],console.error("find-duplicates: Error parsing ISRC cache: ",e)}a.loadedIsrcCache=!0}return a.isrcCache}function p(e){a.loadedIsrcCache=!0,a.isrcCache=e}function y(){if(!a.loadedLibraryIsrcCache){try{a.libraryIsrcCache=JSON.parse(localStorage.getItem("find-duplicates:library-isrc-cache")??"[]")}catch(e){a.libraryIsrcCache=[],console.error("find-duplicates: Error parsing library ISRC cache: ",e)}a.loadedLibraryIsrcCache=!0}return a.libraryIsrcCache}function g(e){a.loadedLibraryIsrcCache=!0,a.libraryIsrcCache=e}function m(){c.loaded=!0;let t=(window.webpackChunkclient_web??window.webpackChunkopen).push([[Symbol()],{},e=>e]);var e=Object.keys(t.m).map(e=>t(e)).filter(e=>"object"==typeof e).map(e=>{try{return Object.values(e)}catch{}}).flat(),r=e.filter(e=>!!e?.type&&e.$$typeof===Symbol.for("react.memo")&&"function"==typeof e.type&&(e=e.type.toString()).includes("defaultCurationContextUri")&&e.includes("web-player.aligned-curation")&&e.includes("isCurated")&&e.includes("default-curation")),r=[...new Set(r)];1!=r.length&&1!=(r=e.filter(e=>!!e?.type&&"function"==typeof e.type&&(e=e.type.toString()).includes("remove-from-library")&&e.includes("add-to-library")&&e.includes("className")&&!e.includes("isEpisode"))).length||(c.heartRendererEntry=r[0],c.heartRenderer=c.heartRendererEntry.type)}async function S(){var e=await k([...new Set(o.registeredEntries.map(e=>e.uri))]);for(let t of o.registeredEntries)t.setState(v(t.uri,e.find(e=>e[0]==t.uri)?.[1])),t.setup=!0;o.started=!1}function v(t,r){var e,i=y().filter(e=>e[1]==r),a=i.some(e=>e[0]==t);let n="";return a?(e=(i.findIndex(e=>e[0]==t)+1)%i.length,n=i[e][0]):0<i.length&&(n=i[0][0]),{count:i.length,saved:a,nextEntry:n}}function b(){c.loaded||m();var e=c.heartRendererEntry;e?(e.type=function(e){let r=e.uri,[t,i]=Spicetify.React.useState({count:0,saved:!1,nextEntry:""});Spicetify.React.useEffect(()=>{let t={uri:r,setState:i,setup:!1};var e;return e=t,o.registeredEntries.push(e),o.started||(o.started=!0,setTimeout(async()=>{if(!C()){var e=o.registeredEntries.filter(e=>!e.setup),r=await k([...new Set(e.map(e=>e.uri))]);for(let t of e)t.setState(v(t.uri,r.find(e=>e[0]==t.uri)?.[1])),t.setup=!0;o.started=!1}},0)),()=>{var e;e=t,0<=(e=o.registeredEntries.indexOf(e))&&o.registeredEntries.splice(e,1)}},[r]);var e=Spicetify.React.useCallback(()=>{var e="/collection/tracks?uri="+encodeURIComponent(t.nextEntry);return"/collection/tracks"===Spicetify.Platform.History.location?.pathname?Spicetify.Platform.History.replace(e):Spicetify.Platform.History.push(e),!1},[t.nextEntry]),a=(c.loaded||m(),c.heartRenderer.apply(this,arguments)),n=t.count-(t.saved?1:0),s=t.saved?"+"+n:n.toString();return Spicetify.React.createElement(Spicetify.React.Fragment,{children:[n?Spicetify.React.createElement("a",{class:"TypeElement-mesto-textSubdued-type",href:"#",onClick:e},s):void 0,a]})},Spicetify.Platform.History.replace(Spicetify.Platform.History.location)):Spicetify.showNotification("Error while attaching save count",!0)}function w(){n.updateRunning?n.reUpdate=!0:async function e(){n.updateRunning=!0;let t=(await Spicetify.Platform.LibraryAPI.getTracks({limit:-1})).items.map(e=>e.uri);let r=y();let i=t.filter(t=>!r.find(e=>e[0]==t));let a=r.filter(e=>!t.includes(e[0])).map(e=>e[0]);r=r.filter(e=>!a.includes(e[0]));for(let t=0;t<i.length;t+=50){let e=i.slice(t,Math.min(t+50,i.length));e.length&&r.push(...await V(e))}g(r);(n.reUpdate?(n.reUpdate=!1,e):S)();n.updateRunning=!1}()}function C(){return n.updateRunning}function I(e,t){return e&1n<<BigInt(8*t-1)?e-(1n<<BigInt(8*t)):e}function E(t,r){return[t[0],e=>r(t[1](e))]}function R(e,t){return{id:e,value:t}}function x(t){return[3,e=>{for(var r=new f(e),i={},a=Object.entries(t).map(([e,t])=>({name:e,...t}));!r.isExhausted();){let t=Number(r.getVarInt());var n=a.find(e=>e.id==t>>3);if(n&&((e,t)=>{switch(t){case 0:return 0==(7&e);case 1:return 5==(7&e);case 2:return 1==(7&e);case 3:return 2==(7&e)}})(t,n.value[0])){var s=n.value,[c,o]=((e,t)=>{switch(t[0]){case 1:return e.has(4)?[!0,t[1](e.getView(4))]:[!1,void 0];case 2:return e.has(8)?[!0,t[1](e.getView(8))]:[!1,void 0];case 0:return[!0,t[1](e.getVarIntView())];case 3:var r=Number(e.getVarInt());return[!0,t[1](e.getView(r))]}})(r,s);if(!c)break;s[2]?(c=i[n.name]??[],i[n.name]=c.concat(o)):i[n.name]=o}else{u=s=l=void 0;var l=r,s=t;switch(7&s){case 5:l.getView(4);break;case 1:l.getView(8);break;case 0:l.getVarIntView();break;case 2:var u=Number(l.getVarInt());l.getView(u)}}}return i}]}function O(e,t){e=new DataView(e.buffer,e.byteOffset,e.byteLength);return t[1](e)}async function V(e){e=await d().fetchAll(e.map(e=>({uri:e,kind:10}))).catch(()=>console.error("find-duplicates: Could not load track metadata"));if(!e)return[];var t,r,i=[];for(t of e)t.success&&0!==t.value.length&&"type.googleapis.com/spotify.metadata.Track"===t.typeUrl&&(r=O(t.value,s)?.externalId?.find(e=>"isrc"===e.type&&e.id)?.id)&&i.push([t.uri,r]);return i}async function k(t){var r=h(),e=y();let i=r.filter(e=>t.includes(e[0]));i.push(...e.filter(e=>t.includes(e[0])));var a=t.filter(t=>!i.find(e=>e[0]==t));for(let e=0;e<a.length;e+=50){var n=a.slice(e,Math.min(e+50,a.length));n.length&&(n=await V(n),i.push(...n),r.push(...n))}return 2e3<r.length&&r.splice(0,r.length-2e3),p(r),i}function N(){return l[Spicetify.Locale._locale]??l.en}(r=class{static init(){let t=(window.webpackChunkclient_web??window.webpackChunkopen).push([[Symbol()],{},e=>e]);var e=Object.keys(t.m).map(e=>t(e));this.modules=e.filter(e=>"object"==typeof e).map(e=>{try{return Object.values(e)}catch{}}).flat()}static getValue(e,t){this.modules||this.init(),e in this.loadedModules||(1===(t=this.modules.filter(t)).length?this.loadedModules[e]={state:"succeeded",value:t[0]}:this.loadedModules[e]={state:"failed"});t=this.loadedModules[e];return"failed"===t.state?null:"succeeded"===t.state?t.value:void 0}static getMetadataService(){return this.getValue("metadataService",e=>e&&"function"==typeof e&&"SERVICE_ID"in e&&"spotify.mdata_esperanto.proto.MetadataService"===e.SERVICE_ID)}static getCreateTransport(){return this.getValue("createTransport",e=>e&&"function"==typeof e&&e.toString().includes("executeEsperantoCall")&&e.toString().includes("cancelEsperantoCall"))}static getStyleSheetManager(){return this.getValue("styleSheetManager",e=>e&&"function"==typeof e&&e.toString().includes("stylisPlugins")&&e.toString().includes("reconstructWithOptions")&&e.toString().includes("disableCSSOMInjection")&&e.toString().includes("disableVendorPrefixes"))}}).modules=null,r.loadedModules={},i=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.OK=1]="OK",e[e.NOT_RESOLVED=2]="NOT_RESOLVED",e[e.NOT_FOUND=3]="NOT_FOUND",e[e.UNAVAILABLE_FOR_LEGAL_REASONS=4]="UNAVAILABLE_FOR_LEGAL_REASONS",e))(i||{}),e=class{constructor(){var e=r.getMetadataService(),t=r.getCreateTransport();e&&t&&(this.serviceDescriptor=e,this.service=new this.serviceDescriptor(t()))}fetch(e,t){return new Promise((i,a)=>{if(this.service&&this.serviceDescriptor){let r=this.service.observe(this.serviceDescriptor.METHODS.observe.requestType.fromPartial({extensionQuery:[{entityUri:t,extensionKind:e}]}),e=>{var t;e.pendingResponse||(r.cancel(),1===e.extensionResult[0].status?(t=e.extensionResult[0].extensionData,i(t)):(t=e.extensionResult[0].details.cacheStatus,a(t)))})}else a(0)})}fetchAll(i){return new Promise((r,e)=>{if(this.service&&this.serviceDescriptor){let t=this.service.observe(this.serviceDescriptor.METHODS.observe.requestType.fromPartial({extensionQuery:i.map(e=>({entityUri:e.uri,extensionKind:e.kind}))}),e=>{e.pendingResponse||(t.cancel(),r(e.extensionResult.map(e=>{var t=1===e.status,r={uri:e.entityUri,kind:e.extensionKind,success:t};return t?{...r,typeUrl:e.extensionData.typeUrl,value:e.extensionData.value}:{...r,status:e.details.cacheStatus}})))})}else e()})}},(a=class{}).loadedIsrcCache=!1,(c=class{}).loaded=a.loadedLibraryIsrcCache=!1,(o=class{}).registeredEntries=[],(n=class{}).updateRunning=o.started=!1,n.reUpdate=!1,f=class{constructor(e){e instanceof DataView&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),this.buffer=e,this.offset=0}getVarIntView(){let e=this.offset;for(;e<this.buffer.length-1&&128&this.buffer[e];)e++;return e++,this.getView(e-this.offset)}getVarInt(){if(this.isExhausted())return 0n;let e=0n,t=0n;for(var r;r=BigInt(this.buffer[this.offset++]),e|=(0x7fn&r)<<t,t+=7n,0x80n&r&&!this.isExhausted(););return e}getArray(e){var e=Math.min(e,this.buffer.length-this.offset),t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getView(e){var e=Math.min(e,this.buffer.length-this.offset),t=new DataView(this.buffer.buffer,this.buffer.byteOffset+this.offset,e);return this.offset+=e,t}has(e){return this.buffer.length-this.offset>=e}isExhausted(){return!this.has(1)}},E(t=[0,e=>new f(e).getVarInt()],e=>!!e),E(t,Number),E(t,e=>Number(I(e,4))),E(t,e=>I(e,8)),t=x({type:R(1,t=[3,e=>(new TextDecoder).decode(e)]),id:R(2,t)}),s=x({externalId:R(10,((t=E(t=t,e=>[e]))[2]=!0,t))}),l={de:{contextMenuText:"Duplikate anzeigen",errorCouldNotRetrieveISRC:"Fehler: ISRC konnte nicht abgerufen werden"},en:{contextMenuText:"View Duplicates",errorCouldNotRetrieveISRC:"Error: Could not retrieve ISRC"}},u=async function(){for(;!(Spicetify?.ContextMenu&&Spicetify?.CosmosAsync&&Spicetify?.Platform?.History&&Spicetify?.Locale&&Spicetify?.URI&&(window.webpackChunkclient_web||window.webpackChunkopen));)await new Promise(e=>setTimeout(e,100));let{ContextMenu:e,Platform:t,URI:r}=Spicetify;Spicetify.Platform.LibraryAPI.getEvents().addListener("update",w),w(),b(),window.addEventListener("beforeunload",()=>{localStorage.setItem("find-duplicates:isrc-cache",JSON.stringify(a.isrcCache)),localStorage.setItem("find-duplicates:library-isrc-cache",JSON.stringify(a.libraryIsrcCache))}),new e.Item(N().contextMenuText,async e=>{e=await(async t=>{var e=h(),r=e.find(e=>e[0]==t);if(r)return r[1];if(r=y().find(e=>e[0]==t))return r[1];if(!C()){r=await d().fetch(10,t).catch(e=>console.error("find-duplicates: Could not load track metadata. Status: "+i[e]));if(r&&0!==r.value.length&&"type.googleapis.com/spotify.metadata.Track"===r.typeUrl){r=O(r.value,s)?.externalId?.find(e=>"isrc"===e.type&&e.id)?.id;if(r)return e.push([t,r]),2e3<e.length&&e.splice(0,e.length-2e3),p(e),r}}})(e[0]);e?t.History.push(`/search/${encodeURIComponent("isrc:"+e)}/tracks`):Spicetify.showNotification(N().errorCouldNotRetrieveISRC,!0)},e=>1==e.length&&r.from(e[0])?.type==r.Type.TRACK).register()},(async()=>{await u()})()})();