(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var r,i,e,d,t,a,n,c,o,s,l,u;function f(e,t){return e&1n<<BigInt(8*t-1)?e-(1n<<BigInt(8*t)):e}function h(t,r){return[t[0],e=>r(t[1](e))]}function p(e,t){return{id:e,value:t}}function y(t){return[3,e=>{for(var r=new d(e),i={},a=Object.entries(t).map(([e,t])=>({name:e,...t}));!r.isExhausted();){let t=Number(r.getVarInt());var n=a.find(e=>e.id==t>>3);if(n&&((e,t)=>{switch(t){case 0:return 0==(7&e);case 1:return 5==(7&e);case 2:return 1==(7&e);case 3:return 2==(7&e)}})(t,n.value[0])){var s=n.value,[c,o]=((e,t)=>{switch(t[0]){case 1:return e.has(4)?[!0,t[1](e.getView(4))]:[!1,void 0];case 2:return e.has(8)?[!0,t[1](e.getView(8))]:[!1,void 0];case 0:return[!0,t[1](e.getVarIntView())];case 3:var r=Number(e.getVarInt());return[!0,t[1](e.getView(r))]}})(r,s);if(!c)break;s[2]?(c=i[n.name]??[],i[n.name]=c.concat(o)):i[n.name]=o}else{u=s=l=void 0;var l=r,s=t;switch(7&s){case 5:l.getView(4);break;case 1:l.getView(8);break;case 0:l.getVarIntView();break;case 2:var u=Number(l.getVarInt());l.getView(u)}}}return i}]}function g(e,t){e=new DataView(e.buffer,e.byteOffset,e.byteLength);return t[1](e)}function S(){return n.metadataService||(n.metadataService=new e),n.metadataService}function m(){if(!n.loadedIsrcCache){try{n.isrcCache=JSON.parse(localStorage.getItem("find-duplicates:isrc-cache")??"[]")}catch(e){n.isrcCache=[],console.error("find-duplicates: Error parsing ISRC cache: ",e)}n.loadedIsrcCache=!0}return n.isrcCache}function b(e){n.loadedIsrcCache=!0,n.isrcCache=e}function v(){if(!n.loadedLibraryIsrcCache){try{n.libraryIsrcCache=JSON.parse(localStorage.getItem("find-duplicates:library-isrc-cache")??"[]")}catch(e){n.libraryIsrcCache=[],console.error("find-duplicates: Error parsing library ISRC cache: ",e)}n.loadedLibraryIsrcCache=!0}return n.libraryIsrcCache}function w(e){n.loadedLibraryIsrcCache=!0,n.libraryIsrcCache=e}function C(){c.loaded=!0;let t=(window.webpackChunkclient_web??window.webpackChunkopen).push([[Symbol()],{},e=>e]);var e=Object.keys(t.m).map(e=>t(e)).filter(e=>"object"==typeof e).map(e=>{try{return Object.values(e)}catch{}}).flat(),r=e.filter(e=>!!e?.type&&e.$$typeof===Symbol.for("react.memo")&&"function"==typeof e.type&&(e=e.type.toString()).includes("defaultCurationContextUri")&&e.includes("web-player.aligned-curation")&&e.includes("isCurated")&&e.includes("default-curation")),r=[...new Set(r)];1!=r.length&&1!=(r=e.filter(e=>!!e?.type&&"function"==typeof e.type&&(e=e.type.toString()).includes("remove-from-library")&&e.includes("add-to-library")&&e.includes("className")&&!e.includes("isEpisode"))).length||(c.heartRendererEntry=r[0],c.heartRenderer=c.heartRendererEntry.type)}async function I(){var e=await O([...new Set(o.registeredEntries.map(e=>e.uri))]);for(let t of o.registeredEntries)t.setState(E(t.uri,e.find(e=>e[0]==t.uri)?.[1])),t.setup=!0;o.started=!1}function E(t,r){var e,i=v().filter(e=>e[1]==r),a=i.some(e=>e[0]==t);let n="";return a?(e=(i.findIndex(e=>e[0]==t)+1)%i.length,n=i[e][0]):0<i.length&&(n=i[0][0]),{count:i.length,saved:a,nextEntry:n}}function R(){c.loaded||C();var e=c.heartRendererEntry;e?(e.type=function(e){let r=e.uri,[t,i]=Spicetify.React.useState({count:0,saved:!1,nextEntry:""});Spicetify.React.useEffect(()=>{let t={uri:r,setState:i,setup:!1};var e;return e=t,o.registeredEntries.push(e),o.started||(o.started=!0,setTimeout(async()=>{if(!V()){var e=o.registeredEntries.filter(e=>!e.setup),r=await O([...new Set(e.map(e=>e.uri))]);for(let t of e)t.setState(E(t.uri,r.find(e=>e[0]==t.uri)?.[1])),t.setup=!0;o.started=!1}},0)),()=>{var e;e=t,0<=(e=o.registeredEntries.indexOf(e))&&o.registeredEntries.splice(e,1)}},[r]);var e=Spicetify.React.useCallback(()=>{var e="/collection/tracks?uri="+encodeURIComponent(t.nextEntry);return"/collection/tracks"===Spicetify.Platform.History.location?.pathname?Spicetify.Platform.History.replace(e):Spicetify.Platform.History.push(e),!1},[t.nextEntry]),a=(c.loaded||C(),c.heartRenderer.apply(this,arguments)),n=t.count-(t.saved?1:0),s=t.saved?"+"+n:n.toString();return Spicetify.React.createElement(Spicetify.React.Fragment,{children:[n?Spicetify.React.createElement("a",{class:"TypeElement-mesto-textSubdued-type",href:"#",onClick:e},s):void 0,a]})},Spicetify.Platform.History.replace(Spicetify.Platform.History.location)):Spicetify.showNotification("Error while attaching save count",!0)}function k(){s.updateRunning?s.reUpdate=!0:async function e(){s.updateRunning=!0;let t=(await Spicetify.Platform.LibraryAPI.getTracks({limit:-1})).items.map(e=>e.uri);let r=v();let i=t.filter(t=>!r.find(e=>e[0]==t));let a=r.filter(e=>!t.includes(e[0])).map(e=>e[0]);r=r.filter(e=>!a.includes(e[0]));for(let t=0;t<i.length;t+=50){let e=i.slice(t,Math.min(t+50,i.length));e.length&&r.push(...await x(e))}w(r);(s.reUpdate?(s.reUpdate=!1,e):I)();s.updateRunning=!1}()}function V(){return s.updateRunning}async function x(e){e=await S().fetchAll(e.map(e=>({uri:e,kind:10}))).catch(()=>console.error("find-duplicates: Could not load track metadata"));if(!e)return[];var t,r,i=[];for(t of e)t.success&&0!==t.value.length&&"type.googleapis.com/spotify.metadata.Track"===t.typeUrl&&(r=g(t.value,a)?.externalId?.find(e=>"isrc"===e.type&&e.id)?.id)&&i.push([t.uri,r]);return i}async function O(t){var r=m(),e=v();let i=r.filter(e=>t.includes(e[0]));i.push(...e.filter(e=>t.includes(e[0])));var a=t.filter(t=>!i.find(e=>e[0]==t));for(let e=0;e<a.length;e+=50){var n=a.slice(e,Math.min(e+50,a.length));n.length&&(n=await x(n),i.push(...n),r.push(...n))}return 2e3<r.length&&r.splice(0,r.length-2e3),b(r),i}function N(){return l[Spicetify.Locale._locale]??l.en}(r=class{static init(){this.webpack=window.webpackChunkclient_web??window.webpackChunkopen,this.require=this.webpack.push([[Symbol()],{},e=>e]),this.refreshModules()}static async loadFiles(e){this.require||this.init(),await Promise.allSettled(e.map(e=>this.require.e(e))),this.refreshModules()}static refreshModules(){this.require||this.init(),this.loadedModules={};var e=Object.keys(this.require.m).map(e=>this.require(e));this.modules=e.filter(e=>"object"==typeof e).map(e=>{try{return Object.values(e)}catch{}}).flat()}static getValue(e,t){this.require||this.init(),e in this.loadedModules||(this.loadedModules[e]=t());t=this.loadedModules[e];return"failed"===t.state?null:"succeeded"===t.state?t.value:void 0}static getValueFiltered(e,t){return this.getValue(e,()=>{var e=this.modules.filter(t);return 1===e.length?{state:"succeeded",value:e[0]}:{state:"failed"}})}static getMetadataService(){return this.getValueFiltered("metadataService",e=>e&&"function"==typeof e&&"SERVICE_ID"in e&&"spotify.mdata_esperanto.proto.MetadataService"===e.SERVICE_ID)}static getOfflinePlayableCache(){return this.getValueFiltered("offlinePlayableCache",e=>e&&"function"==typeof e&&"SERVICE_ID"in e&&"spotify.offline_playable_cache_esperanto.proto.OfflinePlayableCache"===e.SERVICE_ID)}static getCreateTransport(){return this.getValueFiltered("createTransport",e=>e&&"function"==typeof e&&e.toString().includes("executeEsperantoCall")&&e.toString().includes("cancelEsperantoCall"))}static getTrackList(){return this.getValueFiltered("trackList",e=>e&&"object"==typeof e&&e.$$typeof===Symbol.for("react.memo")&&"function"==typeof e.type&&e.type.toString().includes("tracks")&&e.type.toString().includes("nrTracks")&&e.type.toString().includes("fetchTracks")&&e.type.toString().includes("itemsCache")&&e.type.toString().includes("initialItems"))}static getTrackListItem(){return this.getValueFiltered("trackListItem",e=>e&&"object"==typeof e&&e.$$typeof===Symbol.for("react.memo")&&"function"==typeof e.type&&e.type.toString().includes("displayedColumns")&&e.type.toString().includes("albumOrShow")&&e.type.toString().includes("associatedAudioUri"))}static getCardRenderer(){return this.getValueFiltered("cardRenderer",e=>e&&"object"==typeof e&&"render"in e&&"function"==typeof e.render&&e.render.toString().includes("card-title-")&&e.render.toString().includes("card-subtitle-"))}static getStyleSheetManager(){return this.getValueFiltered("styleSheetManager",e=>e&&"function"==typeof e&&e.toString().includes("stylisPlugins")&&e.toString().includes("reconstructWithOptions")&&e.toString().includes("disableCSSOMInjection")&&e.toString().includes("disableVendorPrefixes"))}}).webpack=null,r.require=null,r.modules=null,r.loadedModules={},i=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.OK=1]="OK",e[e.NOT_RESOLVED=2]="NOT_RESOLVED",e[e.NOT_FOUND=3]="NOT_FOUND",e[e.UNAVAILABLE_FOR_LEGAL_REASONS=4]="UNAVAILABLE_FOR_LEGAL_REASONS",e))(i||{}),e=class{constructor(){var e=r.getMetadataService(),t=r.getCreateTransport();e&&t&&(this.serviceDescriptor=e,this.service=new this.serviceDescriptor(t()))}fetch(e,t){return new Promise((i,a)=>{if(this.service&&this.serviceDescriptor){let r=this.service.observe(this.serviceDescriptor.METHODS.observe.requestType.fromPartial({extensionQuery:[{entityUri:t,extensionKind:e}]}),e=>{var t;e.pendingResponse||(r.cancel(),1===e.extensionResult[0].status?(t=e.extensionResult[0].extensionData,i(t)):(t=e.extensionResult[0].details.cacheStatus,a(t)))})}else a(0)})}fetchAll(i){return new Promise((r,e)=>{if(this.service&&this.serviceDescriptor){let t=this.service.observe(this.serviceDescriptor.METHODS.observe.requestType.fromPartial({extensionQuery:i.map(e=>({entityUri:e.uri,extensionKind:e.kind}))}),e=>{e.pendingResponse||(t.cancel(),r(e.extensionResult.map(e=>{var t=1===e.status,r={uri:e.entityUri,kind:e.extensionKind,success:t};return t?{...r,typeUrl:e.extensionData.typeUrl,value:e.extensionData.value}:{...r,status:e.details.cacheStatus}})))})}else e()})}},d=class{constructor(e){e instanceof DataView&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),this.buffer=e,this.offset=0}getVarIntView(){let e=this.offset;for(;e<this.buffer.length-1&&128&this.buffer[e];)e++;return e++,this.getView(e-this.offset)}getVarInt(){if(this.isExhausted())return 0n;let e=0n,t=0n;for(var r;r=BigInt(this.buffer[this.offset++]),e|=(0x7fn&r)<<t,t+=7n,0x80n&r&&!this.isExhausted(););return e}getArray(e){var e=Math.min(e,this.buffer.length-this.offset),t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getView(e){var e=Math.min(e,this.buffer.length-this.offset),t=new DataView(this.buffer.buffer,this.buffer.byteOffset+this.offset,e);return this.offset+=e,t}has(e){return this.buffer.length-this.offset>=e}isExhausted(){return!this.has(1)}},h(t=[0,e=>new d(e).getVarInt()],e=>!!e),h(t,Number),h(t,e=>Number(f(e,4))),h(t,e=>f(e,8)),t=y({type:p(1,t=[3,e=>(new TextDecoder).decode(e)]),id:p(2,t)}),a=y({externalId:p(10,((t=h(t=t,e=>[e]))[2]=!0,t))}),(n=class{}).loadedIsrcCache=!1,(c=class{}).loaded=n.loadedLibraryIsrcCache=!1,(o=class{}).registeredEntries=[],(s=class{}).updateRunning=o.started=!1,s.reUpdate=!1,l={de:{contextMenuText:"Duplikate anzeigen",errorCouldNotRetrieveISRC:"Fehler: ISRC konnte nicht abgerufen werden"},en:{contextMenuText:"View Duplicates",errorCouldNotRetrieveISRC:"Error: Could not retrieve ISRC"}},u=async function(){for(;!(Spicetify?.ContextMenu&&Spicetify?.CosmosAsync&&Spicetify?.Platform?.History&&Spicetify?.Locale&&Spicetify?.URI&&(window.webpackChunkclient_web||window.webpackChunkopen));)await new Promise(e=>setTimeout(e,100));let{ContextMenu:e,Platform:t,URI:r}=Spicetify;Spicetify.Platform.LibraryAPI.getEvents().addListener("update",k),k(),R(),window.addEventListener("beforeunload",()=>{localStorage.setItem("find-duplicates:isrc-cache",JSON.stringify(n.isrcCache)),localStorage.setItem("find-duplicates:library-isrc-cache",JSON.stringify(n.libraryIsrcCache))}),new e.Item(N().contextMenuText,async e=>{e=await(async t=>{var e=m(),r=e.find(e=>e[0]==t);if(r)return r[1];if(r=v().find(e=>e[0]==t))return r[1];if(!V()){r=await S().fetch(10,t).catch(e=>console.error("find-duplicates: Could not load track metadata. Status: "+i[e]));if(r&&0!==r.value.length&&"type.googleapis.com/spotify.metadata.Track"===r.typeUrl){r=g(r.value,a)?.externalId?.find(e=>"isrc"===e.type&&e.id)?.id;if(r)return e.push([t,r]),2e3<e.length&&e.splice(0,e.length-2e3),b(e),r}}})(e[0]);e?t.History.push(`/search/${encodeURIComponent("isrc:"+e)}/tracks`):Spicetify.showNotification(N().errorCouldNotRetrieveISRC,!0)},e=>1==e.length&&r.from(e[0])?.type==r.Type.TRACK).register()},(async()=>{await u()})()})();