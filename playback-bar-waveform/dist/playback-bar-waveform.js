!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var t,n,e;t=class{constructor(){this.playbackBar=null,this.progressBar=null,this.progressBarBg=null,this.progressBarSliderArea=null,this.progressBarSlider=null,this.animations=[],this.resizeHandler=null,this.maskEnabled=!1,this.trackDuration=0,this.onBarMouseEnter=(e=>{this.updateSliderTimestamp(e),e.stopPropagation()}).bind(this),this.onBarMouseLeave=(e=>{var r;null!=(r=this.progressBarSlider)&&delete r.dataset.timestamp,e.stopPropagation()}).bind(this),this.onBarMouseMove=(e=>{this.updateSliderTimestamp(e),e.stopPropagation()}).bind(this)}async init(){for(CSS.registerProperty({name:"--progress-bar-height",syntax:"<length>",initialValue:"4px",inherits:!0}),CSS.registerProperty({name:"--progress-bar-radius",syntax:"<length>",initialValue:"2px",inherits:!0});!(this.playbackBar=document.querySelector(".main-nowPlayingBar-center .playback-bar"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBar=this.playbackBar.querySelector(".progress-bar"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBarBg=this.progressBar.querySelector(".x-progressBar-progressBarBg"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBarSliderArea=this.progressBarBg.querySelector(".x-progressBar-sliderArea"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBarSlider=this.progressBarBg.querySelector(".progress-bar__slider"));)await new Promise(e=>setTimeout(e,300));new ResizeObserver(()=>{var e;null!=(e=this.resizeHandler)&&e.call(this)}).observe(this.progressBarSliderArea);var e=document.createElement("style");e.innerHTML=`
.main-nowPlayingBar-center .playback-bar .progress-bar {
    .x-progressBar-progressBarBg {
        background: none;
    }

    .x-progressBar-sliderArea {
        background: var(--bg-color);
    }
}

.progress-bar:hover .progress-bar__slider[data-timestamp]::before {
    visibility: visible;
}

.progress-bar:hover .progress-bar__slider::before {
    visibility: hidden;
    
    background: var(--spice-card);
    border-radius: 2px;
    padding: 1px 3px;
    position: absolute;
    
    font-size: 10px;
    bottom: 20px;
    left: 1px;
    transform: translate(-50%, -50%);
    
    content: attr(data-timestamp);
}
		`,document.head.appendChild(e)}setResizeHandler(e){this.resizeHandler=e}setMask(e,r){this.trackDuration=r;var t={duration:160,iterations:1,fill:"forwards",easing:"ease-in-out"},s=`url("${e}") center center / 100% 100% no-repeat`,a=null==(a=this.progressBarSliderArea)?void 0:a.animate([{mask:s,offset:0},{mask:s,offset:1}],t);a&&this.animations.push(a),this.maskEnabled||(this.animations.push(...[null==(s=this.playbackBar)?void 0:s.animate([{height:"24px"}],t),null==(a=this.progressBar)?void 0:a.animate([{"--progress-bar-height":"24px","--progress-bar-radius":"0px"}],t),null==(s=this.progressBarSliderArea)?void 0:s.animate([{mask:`url("${e}") center center / 100% 100% no-repeat`}],t),null==(a=this.progressBarSlider)?void 0:a.animate([{height:"24px",width:"2px",borderRadius:"1px",marginLeft:"-1px",boxShadow:"none"}],t)].filter(e=>!!e)),this.trackDuration=r,null!=(s=this.progressBarBg)&&s.addEventListener("mouseenter",this.onBarMouseEnter),null!=(e=this.progressBarBg)&&e.addEventListener("mouseleave",this.onBarMouseLeave),null!=(a=this.progressBarBg)&&a.addEventListener("mousemove",this.onBarMouseMove),this.progressBarSlider&&(this.progressBarSlider.style.transition="none"),this.maskEnabled=!0)}unsetMask(){var e;this.maskEnabled&&(this.animations.forEach(e=>e.reverse()),this.animations=[],null!=(e=this.progressBarBg)&&e.removeEventListener("mouseenter",this.onBarMouseEnter),null!=(e=this.progressBarBg)&&e.removeEventListener("mouseleave",this.onBarMouseLeave),null!=(e=this.progressBarBg)&&e.removeEventListener("mousemove",this.onBarMouseMove),this.progressBarSlider&&(this.progressBarSlider.style.transition="",this.progressBarSlider.style.removeProperty("--progress-bar-transform"),delete this.progressBarSlider.dataset.timestamp),this.maskEnabled=!1)}getMaskSize(){return this.progressBarSliderArea?{width:this.progressBarSliderArea.getBoundingClientRect().width*window.devicePixelRatio,height:24*window.devicePixelRatio}:{width:1,height:1}}updateSliderTimestamp(e){var r;this.progressBarBg&&(r=this.progressBarBg.getBoundingClientRect(),e=(e.clientX-r.left)/r.width,e=Math.max(0,Math.min(1,e)),r=this.trackDuration*e,this.progressBarSlider)&&(this.progressBarSlider.dataset.timestamp=this.formatTimestamp(r),this.progressBarSlider.style.setProperty("--progress-bar-transform",100*e+"%"))}formatTimestamp(e){var r=3600<=e,t=Math.floor(e/3600),s=Math.floor(e%3600/60),e=Math.floor(e%60);return r?`${t}:${String(s).padStart(2,"0")}:`+String(e).padStart(2,"0"):s+":"+String(e).padStart(2,"0")}},n=class{constructor(){this.width=-1,this.height=-1,this.urls=[],this.canvas=null,this.lock=null}async createWaveform(e,r,t){return this.lock&&await this.lock,this.lock=this._createWaveform(e,r,t),this.lock}isSize(e){return this.width===e.width&&this.height===e.height}async _createWaveform(r,e,t){null!=this.canvas&&r===this.width&&e===this.height||(this.width=r,this.height=e,this.canvas=new OffscreenCanvas(r,e));var s=t.track.duration;let a=2*window.devicePixelRatio,i=e/2,o=e/2-a/2;var n,l=e=>i-(this.convertLoudness(e)*o+a/2),h=e=>i+(this.convertLoudness(e)*o+a/2),d=this.canvas.getContext("2d");if(!d)throw new Error("Failed to get 2D context");d.clearRect(0,0,r,e),d.fillStyle="white",d.beginPath(),d.moveTo(0,e/2);for(n of t.segments)d.lineTo(n.start/s*r,l(n.loudness_start)),d.lineTo((n.start+n.loudness_max_time)/s*r,l(n.loudness_max));e=t.segments[t.segments.length-1];d.lineTo((e.start+e.duration)/s*r,l(e.loudness_end)),d.lineTo((e.start+e.duration)/s*r,h(e.loudness_end));for(let e=t.segments.length-1;0<=e;e--){var p=t.segments[e];d.lineTo((p.start+p.loudness_max_time)/s*r,h(p.loudness_max)),d.lineTo(p.start/s*r,h(p.loudness_start))}d.closePath(),d.fill();e=await this.canvas.convertToBlob(),e=URL.createObjectURL(e);return this.urls.push(e),2<this.urls.length&&URL.revokeObjectURL(this.urls.shift()),e}convertLoudness(e){e=Math.pow(10,e/20);return Math.min(Math.max(e,0),1)}},e=async function(){for(var e;null==Spicetify||!Spicetify.CosmosAsync||null==(e=null==Spicetify?void 0:Spicetify.Player)||!e.data;)await new Promise(e=>setTimeout(e,100));let s=new t,a=(await s.init(),new n),i=null,o=async e=>{var r,t;i&&(t=s.getMaskSize(),t=await a.createWaveform(t.width,t.height,i),(null==(r=null==(r=Spicetify.Player.data)?void 0:r.item)?void 0:r.uri)===e)&&s.setMask(t,i.track.duration)},r=async e=>{s.unsetMask();var r,t,e=(i=null)==e?void 0:e.item;e&&(t=Spicetify.URI.fromString(e.uri)).type===Spicetify.URI.Type.TRACK&&(t=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${t.id}?format=json`,(t=await Spicetify.CosmosAsync.get(t).catch(e=>console.error("[Waveform Playback Bar] Error while loading audio analysis data",e)))?"object"==typeof t&&"track"in t&&"segments"in t?(null==(r=null==(r=Spicetify.Player.data)?void 0:r.item)?void 0:r.uri)===e.uri&&(i=t,o(e.uri)):console.error("[Waveform Playback Bar] Invalid audio analysis data",t):console.error("[Waveform Playback Bar] Error while loading audio analysis data"))};s.setResizeHandler(()=>{var e;a.isSize(s.getMaskSize())||o(null==(e=null==(e=Spicetify.Player.data)?void 0:e.item)?void 0:e.uri)}),Spicetify.Player.addEventListener("songchange",e=>{null!=e&&e.data&&r(e.data)}),r(Spicetify.Player.data)},(async()=>{await e()})()}();