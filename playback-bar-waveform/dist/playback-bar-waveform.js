!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var a,r,n,e;a="progress_bar_waveform_mask",r=class{constructor(){this.playbackBar=null,this.progressBar=null,this.progressBarBg=null,this.progressBarSliderAreas=[],this.progressBarSlider=null,this.maskSvgImageElement=null,this.maskSvgRectElement=null,this.animations=[],this.resizeHandler=null,this.maskEnabled=!1,this.trackDuration=0,this.onBarMouseEnter=(e=>{this.updateSliderTimestamp(e),e.stopPropagation()}).bind(this),this.onBarMouseLeave=(e=>{var t;null!=(t=this.progressBarSlider)&&delete t.dataset.timestamp,e.stopPropagation()}).bind(this),this.onBarMouseMove=(e=>{this.updateSliderTimestamp(e),e.stopPropagation()}).bind(this)}async init(){for(CSS.registerProperty({name:"--progress-bar-height",syntax:"<length>",initialValue:"4px",inherits:!0}),CSS.registerProperty({name:"--progress-bar-radius",syntax:"<length>",initialValue:"2px",inherits:!0});!(this.playbackBar=document.querySelector(".main-nowPlayingBar-center .playback-bar"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBar=this.playbackBar.querySelector(".progress-bar"));)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBarBg=this.progressBar.querySelector(".x-progressBar-progressBarBg"));)await new Promise(e=>setTimeout(e,300));for(;0===(this.progressBarSliderAreas=[...this.progressBarBg.querySelectorAll(".x-progressBar-sliderArea")]).length;)await new Promise(e=>setTimeout(e,300));for(;!(this.progressBarSlider=this.progressBarBg.querySelector(".progress-bar__slider"));)await new Promise(e=>setTimeout(e,300));new ResizeObserver(()=>{var e;null!=(e=this.resizeHandler)&&e.call(this)}).observe(this.progressBarSliderAreas[0]);var e=document.createElement("style"),e=(e.innerHTML=`
.main-nowPlayingBar-center .playback-bar .progress-bar {
    .x-progressBar-progressBarBg {
        background: none;
    }

    .x-progressBar-sliderArea:not(:has(.x-progressBar-fillColor)) {
        background: var(--bg-color);
    }
}

.progress-bar:hover .progress-bar__slider[data-timestamp]::before {
    visibility: visible;
}

.progress-bar:hover .progress-bar__slider::before {
    visibility: hidden;
    
    background: var(--spice-card);
    border-radius: 2px;
    padding: 1px 3px;
    position: absolute;
    
    font-size: 10px;
    bottom: 20px;
    left: 1px;
    transform: translate(-50%, -50%);
    
    content: attr(data-timestamp);
}
		`,document.head.appendChild(e),document.createElementNS("http://www.w3.org/2000/svg","svg")),t=(e.style.position="absolute",e.style.width="0",e.style.height="0",document.createElementNS("http://www.w3.org/2000/svg","defs")),r=document.createElementNS("http://www.w3.org/2000/svg","mask"),s=(r.id=a,r.setAttribute("maskUnits","objectBoundingBox"),r.setAttribute("maskContentUnits","objectBoundingBox"),document.createElementNS("http://www.w3.org/2000/svg","rect")),i=(s.setAttribute("fill","white"),s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("width","1"),s.setAttribute("height","1"),r.appendChild(s),document.createElementNS("http://www.w3.org/2000/svg","image"));i.setAttribute("x","0"),i.setAttribute("y","0"),i.setAttribute("width","1"),i.setAttribute("height","1"),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("decoding","sync"),i.setAttribute("href",""),r.appendChild(i),t.appendChild(r),e.appendChild(t),document.body.appendChild(e),this.progressBarSliderAreas.forEach(e=>e.animate([{mask:`url(#${a})`}],{duration:0,iterations:1,fill:"forwards"})),this.maskSvgImageElement=i,this.maskSvgRectElement=s}setResizeHandler(e){this.resizeHandler=e}setMask(e,t){this.trackDuration=t;var r,s={duration:160,iterations:1,fill:"forwards",easing:"ease-in-out"};null!=(r=this.maskSvgImageElement)&&r.setAttribute("href",e),this.maskEnabled||(this.animations.push(...[null==(r=this.maskSvgRectElement)?void 0:r.animate([{height:0,y:.5}],s),null==(e=this.playbackBar)?void 0:e.animate([{height:"24px"}],s),null==(r=this.progressBar)?void 0:r.animate([{"--progress-bar-height":"24px","--progress-bar-radius":"0px"}],s),null==(e=this.progressBarSlider)?void 0:e.animate([{height:"24px",width:"2px",borderRadius:"1px",marginLeft:"-1px",boxShadow:"none"}],s)].filter(e=>!!e)),this.trackDuration=t,null!=(r=this.progressBarBg)&&r.addEventListener("mouseenter",this.onBarMouseEnter),null!=(e=this.progressBarBg)&&e.addEventListener("mouseleave",this.onBarMouseLeave),null!=(s=this.progressBarBg)&&s.addEventListener("mousemove",this.onBarMouseMove),this.progressBarSlider&&(this.progressBarSlider.style.transition="none"),this.maskEnabled=!0)}unsetMask(){var e;this.maskEnabled&&(this.animations.forEach(e=>e.reverse()),this.animations=[],null!=(e=this.progressBarBg)&&e.removeEventListener("mouseenter",this.onBarMouseEnter),null!=(e=this.progressBarBg)&&e.removeEventListener("mouseleave",this.onBarMouseLeave),null!=(e=this.progressBarBg)&&e.removeEventListener("mousemove",this.onBarMouseMove),this.progressBarSlider&&(this.progressBarSlider.style.transition="",this.progressBarSlider.style.removeProperty("--progress-bar-transform"),delete this.progressBarSlider.dataset.timestamp),this.maskEnabled=!1)}getMaskSize(){return this.progressBarSliderAreas[0]?{width:this.progressBarSliderAreas[0].getBoundingClientRect().width*window.devicePixelRatio,height:24*window.devicePixelRatio}:{width:1,height:1}}updateSliderTimestamp(e){var t;this.progressBarBg&&(t=this.progressBarBg.getBoundingClientRect(),e=(e.clientX-t.left)/t.width,e=Math.max(0,Math.min(1,e)),t=this.trackDuration*e,this.progressBarSlider)&&(this.progressBarSlider.dataset.timestamp=this.formatTimestamp(t),this.progressBarSlider.style.setProperty("--progress-bar-transform",100*e+"%"))}formatTimestamp(e){var t=3600<=e,r=Math.floor(e/3600),s=Math.floor(e%3600/60),e=Math.floor(e%60);return t?`${r}:${String(s).padStart(2,"0")}:`+String(e).padStart(2,"0"):s+":"+String(e).padStart(2,"0")}},n=class{constructor(){this.width=-1,this.height=-1,this.urls=[],this.canvas=null,this.lock=null}async createWaveform(e,t,r){return this.lock&&await this.lock,this.lock=this._createWaveform(e,t,r),this.lock}isSize(e){return this.width===e.width&&this.height===e.height}async _createWaveform(t,e,r){null!=this.canvas&&t===this.width&&e===this.height||(this.width=t,this.height=e,this.canvas=new OffscreenCanvas(t,e));var s=r.track.duration;let i=2*window.devicePixelRatio,a=e/2,o=e/2-i/2;var n,l=e=>a-(this.convertLoudness(e)*o+i/2),h=e=>a+(this.convertLoudness(e)*o+i/2),d=this.canvas.getContext("2d");if(!d)throw new Error("Failed to get 2D context");d.clearRect(0,0,t,e),d.fillStyle="white",d.beginPath(),d.moveTo(0,e/2);for(n of r.segments)d.lineTo(n.start/s*t,l(n.loudness_start)),d.lineTo((n.start+n.loudness_max_time)/s*t,l(n.loudness_max));e=r.segments[r.segments.length-1];d.lineTo((e.start+e.duration)/s*t,l(e.loudness_end)),d.lineTo((e.start+e.duration)/s*t,h(e.loudness_end));for(let e=r.segments.length-1;0<=e;e--){var u=r.segments[e];d.lineTo((u.start+u.loudness_max_time)/s*t,h(u.loudness_max)),d.lineTo(u.start/s*t,h(u.loudness_start))}d.closePath(),d.fill();e=await this.canvas.convertToBlob(),e=URL.createObjectURL(e);return this.urls.push(e),2<this.urls.length&&URL.revokeObjectURL(this.urls.shift()),e}convertLoudness(e){e=Math.pow(10,e/20);return Math.min(Math.max(e,0),1)}},e=async function(){for(var e;null==Spicetify||!Spicetify.CosmosAsync||null==(e=null==Spicetify?void 0:Spicetify.Player)||!e.data;)await new Promise(e=>setTimeout(e,100));let s=new r,i=(await s.init(),new n),a=null,o=async e=>{var t,r;a&&(r=s.getMaskSize(),r=await i.createWaveform(r.width,r.height,a),(null==(t=null==(t=Spicetify.Player.data)?void 0:t.item)?void 0:t.uri)===e)&&s.setMask(r,a.track.duration)},t=async e=>{s.unsetMask();var t,r,e=(a=null)==e?void 0:e.item;e&&(r=Spicetify.URI.fromString(e.uri)).type===Spicetify.URI.Type.TRACK&&(r=`https://spclient.wg.spotify.com/audio-attributes/v1/audio-analysis/${r.id}?format=json`,(r=await Spicetify.CosmosAsync.get(r).catch(e=>console.error("[Waveform Playback Bar] Error while loading audio analysis data",e)))?"object"==typeof r&&"track"in r&&"segments"in r?(null==(t=null==(t=Spicetify.Player.data)?void 0:t.item)?void 0:t.uri)===e.uri&&(a=r,o(e.uri)):console.error("[Waveform Playback Bar] Invalid audio analysis data",r):console.error("[Waveform Playback Bar] Error while loading audio analysis data"))};s.setResizeHandler(()=>{var e;i.isSize(s.getMaskSize())||o(null==(e=null==(e=Spicetify.Player.data)?void 0:e.item)?void 0:e.uri)}),Spicetify.Player.addEventListener("songchange",e=>{null!=e&&e.data&&t(e.data)}),t(Spicetify.Player.data)},(async()=>{await e()})()}();